# =============================================================================
# Rosetta Platform - Nginx Config for FULL DOCKER STACK
# =============================================================================
#
# USE THIS WHEN: All services run in Docker (docker-compose up)
#
# ROUTING:
#   /auth/*    → auth-service:3002
#   /api/*     → backend:8080
#   /editor/*  → be-editor:3001
#   /studio/*  → fe-editor:5173
#   /*         → frontend:3000
#
# =============================================================================

# =============================================================================
# CUSTOM LOG FORMAT
# =============================================================================

log_format rosetta '$remote_addr - $time_local - $request - $status - $upstream_response_time - $upstream_addr';

# Access log using our custom format (writes to Docker stdout)
access_log /var/log/nginx/access.log rosetta;

# =============================================================================
# RATE LIMITING ZONES
# =============================================================================
# Define shared memory zones for tracking request rates per client IP

# Auth endpoints - stricter limits for security
limit_req_zone $binary_remote_addr zone=auth_login:10m rate=10r/m;
limit_req_zone $binary_remote_addr zone=auth_validate:10m rate=60r/m;

# API endpoints - generous for normal app usage
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# Editor endpoints - moderate for diagram operations
limit_req_zone $binary_remote_addr zone=editor_limit:10m rate=10r/s;

# =============================================================================
# UPSTREAM DEFINITIONS
# =============================================================================

upstream fe {
    # Frontend Dockerfile runs nginx on port 80 (production build)
    server frontend:80;
}

upstream fe-editor {
    # fe-editor Dockerfile also runs nginx on port 80 (production build)
    server fe-editor:80;
}

upstream be {
    least_conn;

    server backend-1:8080 max_fails=3 fail_timeout=30s;
    server backend-2:8080 max_fails=3 fail_timeout=30s;
    server backend-3:8080 max_fails=3 fail_timeout=30s;
}

upstream be-editor {
    server be-editor:3001;
}

upstream auth-service {
    server auth-service:3002;
}

server {
    listen 80;
    server_name localhost;

    # Buffer settings for large headers (JWTs)
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # =========================================================================
    # /auth/* → auth-service (with rate limiting)
    # =========================================================================

    # Critical: Login endpoint (brute force protection)
    location = /auth/login {
        limit_req zone=auth_login burst=5 nodelay;

        proxy_pass http://auth-service/auth/login;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frequently called: Validate endpoint (frontend session checks)
    location = /auth/validate {
        limit_req zone=auth_validate burst=5 nodelay;

        proxy_pass http://auth-service/auth/validate;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # OAuth callback (called by Microsoft, no rate limit needed)
    location = /auth/callback {
        proxy_pass http://auth-service/auth/callback;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Logout endpoint (low risk)
    location = /auth/logout {
        proxy_pass http://auth-service/auth/logout;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Block all other /auth/* paths (security catch-all)
    location /auth/ {
        return 403 "Forbidden: Unknown auth endpoint";
    }

    # =========================================================================
    # /editor/* → be-editor
    # =========================================================================

    # -------------------------------------------------------------------------
    # INTERNAL ONLY - Service-to-service diagram endpoints
    # -------------------------------------------------------------------------
    location ~ ^/editor/diagrams/by-lp {
        return 403 "Forbidden: Internal service endpoint - only accessible by backend services";
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # PUBLIC - WebSocket endpoint for collaborative editing
    # -------------------------------------------------------------------------
    location = /editor/ws {
        rewrite ^/editor/ws$ / break;

        proxy_pass http://be-editor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # -------------------------------------------------------------------------
    # PUBLIC - All other editor endpoints (diagrams CRUD)
    # -------------------------------------------------------------------------
    location /editor/ {
        limit_req zone=editor_limit burst=30 nodelay;

        rewrite ^/editor/(.*)$ /api/$1 break;

        proxy_pass http://be-editor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # /api/* → backend (BE) with rate limiting
    # =========================================================================
    location /api/ {
        limit_req zone=api_limit burst=50 nodelay;

        proxy_pass http://be/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # /studio/* → fe-editor
    # =========================================================================
    # fe-editor is built with base: '/studio/' so assets are at /studio/assets/*
    # Pass the full path without stripping /studio
    location /studio/ {
        proxy_pass http://fe-editor/studio/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket for Vite HMR
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # =========================================================================
    # /* → frontend (default)
    # =========================================================================
    location / {
        proxy_pass http://fe;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket for Vite HMR
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Health check
    location /health {
        return 200 'nginx OK';
        add_header Content-Type text/plain;
    }
}
