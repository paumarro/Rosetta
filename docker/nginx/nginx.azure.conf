# =============================================================================
# Rosetta Platform - Nginx Config for AZURE CONTAINER APPS
# =============================================================================
#
# All services use internal ingress on port 80 (Azure handles port mapping).
#
# ROUTING:
#   /api/*     -> backend (Go, target port 8080)
#   /editor/*  -> backend-editor (Node, target port 3001)
#   /studio/*  -> frontend-editor (nginx SPA)
#   /auth/*    -> auth-service (Go, target port 3002)
#   /*         -> frontend (nginx SPA)
#
# =============================================================================

# =============================================================================
# CUSTOM LOG FORMAT
# =============================================================================

log_format rosetta '$remote_addr - $time_local - $request - $status - $upstream_response_time - $upstream_addr';

access_log /var/log/nginx/access.log rosetta;

# =============================================================================
# LARGE HEADER/COOKIE HANDLING (Microsoft OAuth tokens are large)
# =============================================================================

client_header_buffer_size 4k;
large_client_header_buffers 8 64k;

# =============================================================================
# WEBSOCKET CONNECTION UPGRADE MAP
# =============================================================================
# Sets Connection header to "upgrade" only when Upgrade header is present

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# =============================================================================
# RATE LIMITING ZONES
# =============================================================================

limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=editor_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;

# =============================================================================
# UPSTREAM DEFINITIONS
# =============================================================================
# Azure Container Apps internal service discovery uses full internal FQDNs.
# All internal traffic goes through port 80 (Azure ingress handles port mapping)

upstream fe {
    server frontend.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io:80;
}

upstream fe-editor {
    server frontend-editor.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io:80;
}

upstream be {
    # Let ACA's native load balancer handle distribution (no least_conn)
    server backend.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io:80;
}

upstream be-editor {
    # Single instance - see ADR-004 for scaling to Fixed Replicas or Redis State
    server backend-editor.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io:80;
}

upstream auth-service {
    server auth-service.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io:80;
}

server {
    listen 80;
    server_name _;

    # Buffer settings for large headers (JWTs)
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # =========================================================================
    # /auth/* -> auth-service (OAuth flow)
    # =========================================================================
    location /auth/ {
        limit_req zone=auth_limit burst=10 nodelay;

        proxy_pass http://auth-service/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host auth-service.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # =========================================================================
    # /editor/* -> backend-editor
    # =========================================================================

    # Internal only - Service-to-service diagram endpoints
    location ~ ^/editor/diagrams/by-lp {
        return 403 "Forbidden: Internal service endpoint";
        add_header Content-Type text/plain;
    }

    # WebSocket endpoint for collaborative editing
    location /editor/ws/ {
        rewrite ^/editor/ws/(.*)$ /$1 break;

        proxy_pass http://be-editor;
        proxy_set_header Host backend-editor.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # All other editor endpoints (diagrams CRUD)
    location /editor/ {
        limit_req zone=editor_limit burst=30 nodelay;

        rewrite ^/editor/(.*)$ /api/$1 break;

        proxy_pass http://be-editor;
        proxy_http_version 1.1;
        proxy_set_header Host backend-editor.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # =========================================================================
    # /api/* -> backend with rate limiting
    # =========================================================================
    location /api/ {
        limit_req zone=api_limit burst=50 nodelay;

        proxy_pass http://be/api/;
        proxy_http_version 1.1;
        proxy_set_header Host backend.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # =========================================================================
    # /studio/* -> frontend-editor
    # =========================================================================
    location /studio/ {
        limit_req zone=api_limit burst=50 nodelay;

        proxy_pass http://fe-editor/studio/;
        proxy_http_version 1.1;
        proxy_set_header Host frontend-editor.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # =========================================================================
    # /* -> frontend (default)
    # =========================================================================
    location / {
        proxy_pass http://fe;
        proxy_http_version 1.1;
        proxy_set_header Host frontend.internal.purplebay-96c2df34.westeurope.azurecontainerapps.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Health check
    location /health {
        return 200 'nginx OK';
        add_header Content-Type text/plain;
    }
}
