# Rosetta Platform - Nginx Config for Local Development (Frontend Hot-Reload)
# =============================================================================
#
# This config is used when ONLY FRONTENDS run locally for hot-reload.
# Backends, databases, and nginx remain in Docker.
#
# Use with: docker compose -f docker-compose.yml -f docker-compose.local.yml up
#
# ROUTING:
#   /api/*     → backend-1/2/3:8080        (Docker containers with load balancing)
#   /editor/*  → be-editor:3001            (Docker container)
#   /studio/*  → host.docker.internal:5173 (LOCAL - fe-editor on your Mac)
#   /*         → host.docker.internal:3000 (LOCAL - frontend on your Mac)
#
# NOTE: auth-service has been deprecated - backends validate tokens locally
#
# EXPECTED LOCAL SERVICES:
#   - frontend:     npm run dev → localhost:3000
#   - fe-editor:    npm run dev → localhost:5173
#
# =============================================================================

# =============================================================================
# UPSTREAM DEFINITIONS
# =============================================================================

# FRONTENDS - Run locally on host machine
upstream fe {
    server host.docker.internal:3000;
}

upstream fe-editor {
    server host.docker.internal:5173;
}

# BACKENDS - Run in Docker containers
upstream be {
    least_conn;
    server backend-1:8080 max_fails=3 fail_timeout=30s;
    server backend-2:8080 max_fails=3 fail_timeout=30s;
    server backend-3:8080 max_fails=3 fail_timeout=30s;
}

upstream be-editor {
    server be-editor:3001;
}

# auth-service handles OAuth flow only (login, callback, logout, refresh)
# Token validation is done locally by backends
upstream auth-service {
    server auth-service:3002;
}

# =============================================================================
# MAIN SERVER BLOCK
# =============================================================================

server {
    listen 80;
    server_name localhost;

    # Buffer settings for large headers (JWTs)
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # =========================================================================
    # /auth/* → auth-service (OAuth flow only)
    # =========================================================================
    # Auth-service handles OAuth flow (login, callback, logout, refresh)
    # Token validation is done locally by backends using Microsoft's JWKS

    location /auth/ {
        proxy_pass http://auth-service/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # /editor/* → be-editor (Docker)
    # =========================================================================

    # WebSocket endpoint for collaborative editing
    location /editor/ws/ {
        rewrite ^/editor/ws/(.*)$ /$1 break;

        proxy_pass http://be-editor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # All other editor endpoints (diagrams CRUD)
    location /editor/ {
        rewrite ^/editor/(.*)$ /api/$1 break;

        proxy_pass http://be-editor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # /api/* → backend (Docker - load balanced across 3 replicas)
    # =========================================================================
    location /api/ {
        proxy_pass http://be/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # /studio/* → fe-editor (LOCAL - running on host machine)
    # =========================================================================
    location /studio/ {
        proxy_pass http://fe-editor/studio/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket for Vite HMR
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # =========================================================================
    # /* → frontend (LOCAL - running on host machine)
    # =========================================================================
    location / {
        proxy_pass http://fe;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket for Vite HMR
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Health check
    location /health {
        return 200 'nginx OK';
        add_header Content-Type text/plain;
    }
}
