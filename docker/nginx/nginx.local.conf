# Rosetta Platform - Nginx Config for Local Development
# ======================================================
#
# This config routes to services running on your HOST machine (not in Docker).
# Use with: docker compose -f docker-compose.yml -f docker-compose.local.yml up
#
# KEY DIFFERENCE FROM nginx.conf:
#   nginx.conf:       proxy_pass http://frontend:3000     (Docker container name)
#   nginx.local.conf: proxy_pass http://host.docker.internal:3000 (Your Mac)
#
# EXPECTED LOCAL SERVICES:
#   - FE:           npm run dev          → localhost:3000
#   - fe-editor:    npm run dev          → localhost:5173
#   - BE:           go run cmd/main.go   → localhost:8080
#   - be-editor:    npm run dev          → localhost:3001
#   - auth-service: go run cmd/main.go   → localhost:3002

# ─────────────────────────────────────────────────────────────────────────────
# UPSTREAM DEFINITIONS - Point to host machine
# ─────────────────────────────────────────────────────────────────────────────
upstream frontend {
    server host.docker.internal:3000;
}

upstream fe-editor {
    server host.docker.internal:5173;
}

upstream backend {
    server host.docker.internal:8080;
}

upstream be-editor {
    server host.docker.internal:3001;
}

upstream auth-service {
    server host.docker.internal:3002;
}

# ─────────────────────────────────────────────────────────────────────────────
# MAIN SERVER BLOCK
# ─────────────────────────────────────────────────────────────────────────────
server {
    listen 80;
    server_name localhost;

    # ─────────────────────────────────────────────────────────────────────────
    # /auth/* → auth-service (OAuth, token validation)
    # ─────────────────────────────────────────────────────────────────────────
    location /auth/ {
        proxy_pass http://auth-service/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ─────────────────────────────────────────────────────────────────────────
    # /api/* → BE (users, learning paths, PostgreSQL data)
    # ─────────────────────────────────────────────────────────────────────────
    location /api/ {
        proxy_pass http://backend/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ─────────────────────────────────────────────────────────────────────────
    # /editor/ws → be-editor WebSocket (Yjs collaboration)
    # ─────────────────────────────────────────────────────────────────────────
    location = /editor/ws {
        proxy_pass http://be-editor/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }

    # ─────────────────────────────────────────────────────────────────────────
    # /editor/* → be-editor API (diagrams CRUD)
    # ─────────────────────────────────────────────────────────────────────────
    location /editor/ {
        rewrite ^/editor/(.*)$ /api/$1 break;
        proxy_pass http://be-editor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ─────────────────────────────────────────────────────────────────────────
    # /studio/* → fe-editor (Vite dev server with HMR)
    # ─────────────────────────────────────────────────────────────────────────
    location /studio/ {
        rewrite ^/studio/(.*)$ /$1 break;
        proxy_pass http://fe-editor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Vite HMR WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ─────────────────────────────────────────────────────────────────────────
    # /* → FE (default, main frontend)
    # ─────────────────────────────────────────────────────────────────────────
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Vite HMR WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
