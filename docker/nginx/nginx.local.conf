# Rosetta Platform - Nginx Config for Local Development (Frontend Hot-Reload)
# =============================================================================
#
# This config is used when ONLY FRONTENDS run locally for hot-reload.
# Backends, databases, and nginx remain in Docker.
#
# Use with: docker compose -f docker-compose.yml -f docker-compose.local.yml up
#
# ROUTING:
#   /api/*     → backend-1/2/3:8080        (Docker containers with load balancing)
#   /editor/*  → be-editor-1/2/3:3001      (Docker containers with URI-based sharding)
#   /studio/*  → host.docker.internal:5173 (LOCAL - fe-editor on your Mac)
#   /*         → host.docker.internal:3000 (LOCAL - frontend on your Mac)
#
# NOTE: auth-service has been deprecated - backends validate tokens locally
#
# EXPECTED LOCAL SERVICES:
#   - frontend:     npm run dev → localhost:3000
#   - fe-editor:    npm run dev → localhost:5173
#
# =============================================================================

# =============================================================================
# RATE LIMITING ZONES
# =============================================================================
# Define shared memory zones for tracking request rates per client IP

# API endpoints - generous for normal app usage
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# Editor endpoints - moderate for diagram operations
limit_req_zone $binary_remote_addr zone=editor_limit:10m rate=10r/s;

# =============================================================================
# UPSTREAM DEFINITIONS
# =============================================================================

# FRONTENDS - Run locally on host machine
upstream fe {
    server host.docker.internal:3000;
}

upstream fe-editor {
    server host.docker.internal:5173;
}

# BACKENDS - Run in Docker containers
upstream be {
    least_conn;
    server backend-1:8080 max_fails=3 fail_timeout=30s;
    server backend-2:8080 max_fails=3 fail_timeout=30s;
    server backend-3:8080 max_fails=3 fail_timeout=30s;
}

upstream be-editor {
    # URI-based consistent hashing - route by document name
    # All clients editing same diagram connect to same server
    # On server failure, only its diagrams redistribute (consistent hashing)
    hash $request_uri consistent;

    server be-editor-1:3001 max_fails=3 fail_timeout=30s;
    server be-editor-2:3001 max_fails=3 fail_timeout=30s;
    server be-editor-3:3001 max_fails=3 fail_timeout=30s;
}

# auth-service handles OAuth flow only (login, callback, logout, refresh)
# Token validation is done locally by backends
upstream auth-service {
    server auth-service:3002;
}

# =============================================================================
# MAIN SERVER BLOCK
# =============================================================================

server {
    listen 80;
    server_name localhost;

    # Buffer settings for large headers (JWTs)
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # =========================================================================
    # /auth/* → auth-service (OAuth flow only)
    # =========================================================================
    # Auth-service handles OAuth flow (login, callback, logout, refresh)
    # Token validation is done locally by backends using Microsoft's JWKS

    location /auth/ {
        proxy_pass http://auth-service/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # /editor/* → be-editor (Docker - sharded by URI)
    # =========================================================================

    # -------------------------------------------------------------------------
    # INTERNAL ONLY - Service-to-service diagram endpoints
    # -------------------------------------------------------------------------
    # NOTE: IP restrictions removed - backend-editor validates tokens (Zero Trust)
    location ~ ^/editor/diagrams/by-lp {
        rewrite ^/editor/(.*)$ /api/$1 break;
        proxy_pass http://be-editor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }

    # -------------------------------------------------------------------------
    # PUBLIC - WebSocket endpoint for collaborative editing
    # -------------------------------------------------------------------------
    location /editor/ws/ {
        rewrite ^/editor/ws/(.*)$ /$1 break;

        proxy_pass http://be-editor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # -------------------------------------------------------------------------
    # PUBLIC - All other editor endpoints (diagrams CRUD)
    # -------------------------------------------------------------------------
    location /editor/ {
        limit_req zone=editor_limit burst=30 nodelay;

        rewrite ^/editor/(.*)$ /api/$1 break;

        proxy_pass http://be-editor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # /api/* → backend (Docker - load balanced across 3 replicas)
    # =========================================================================
    location /api/ {
        limit_req zone=api_limit burst=50 nodelay;

        proxy_pass http://be/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =========================================================================
    # /studio/* → fe-editor (LOCAL - running on host machine)
    # =========================================================================
    location /studio/ {
        proxy_pass http://fe-editor/studio/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket for Vite HMR
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # =========================================================================
    # /* → frontend (LOCAL - running on host machine)
    # =========================================================================
    location / {
        proxy_pass http://fe;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket for Vite HMR
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Health check
    location /health {
        return 200 'nginx OK';
        add_header Content-Type text/plain;
    }
}
