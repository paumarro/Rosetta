# Azure Pipeline for Rosetta Monorepo
# Builds and tests all services and applications

trigger:
  branches:
    include:
      - main
      - dev
  paths:
    include:
      - services/*
      - apps/*
      - docker/*

pr:
  branches:
    include:
      - main
      - dev

# Define variables
variables:
  - name: azureSubscription
    value: '076663e1-eb60-4e0e-8a07-45dc414dffd0'
  - name: resourceGroup
    value: 'rg-rosetta'
  - name: containerRegistry
    value: 'rosettaacr.azurecr.io'
  - name: acrName
    value: 'rosettaacr'
  - name: dockerfilePathBackend
    value: 'services/backend/Dockerfile'
  - name: dockerfilePathBackendEditor
    value: 'services/backend-editor/Dockerfile'
  - name: dockerfilePathAuthService
    value: 'services/auth-service/Dockerfile'
  - name: dockerfilePathFrontend
    value: 'apps/frontend/Dockerfile'
  - name: dockerfilePathFrontendEditor
    value: 'apps/frontend-editor/Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'

# Define stages
stages:
  # ============================================
  # STAGE 1: BUILD & TEST
  # ============================================
  - stage: BuildAndTest
    displayName: 'Build and Test All Services'
    jobs:
      # -------------------------------------
      # Backend (Go)
      # -------------------------------------
      - job: BuildBackend
        displayName: 'Build Backend (Go)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 1
          
          - task: GoTool@0
            displayName: 'Install Go'
            inputs:
              version: '1.21'
          
          - script: |
              cd services/backend
              go mod download
              go mod verify
            displayName: 'Download Go dependencies'
          
          - script: |
              cd services/backend
              go test ./... -v -coverprofile=coverage.out
            displayName: 'Run Go tests'
          
          - script: |
              cd services/backend
              go build -o main ./cmd/main.go
            displayName: 'Build Go binary'
          
          - task: PublishTestResults@2
            displayName: 'Publish test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              failTaskOnFailedTests: true
            condition: succeededOrFailed()
          
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: 'services/backend/coverage.out'
            condition: succeededOrFailed()

      # -------------------------------------
      # Auth Service (Go)
      # -------------------------------------
      - job: BuildAuthService
        displayName: 'Build Auth Service (Go)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 1
          
          - task: GoTool@0
            displayName: 'Install Go'
            inputs:
              version: '1.21'
          
          - script: |
              cd services/auth-service
              go mod download
              go test ./... -v
              go build -o main ./cmd/main.go
            displayName: 'Build auth service'

      # -------------------------------------
      # Backend Editor (Node.js)
      # -------------------------------------
      - job: BuildBackendEditor
        displayName: 'Build Backend Editor (Node.js)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 1
          
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'
          
          - script: |
              cd services/backend-editor
              npm ci
            displayName: 'Install dependencies'
          
          - script: |
              cd services/backend-editor
              npm run build
            displayName: 'Build TypeScript'
          
          - script: |
              cd services/backend-editor
              npm test
            displayName: 'Run tests'
            condition: succeededOrFailed()

      # -------------------------------------
      # Frontend (React)
      # -------------------------------------
      - job: BuildFrontend
        displayName: 'Build Frontend (React)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 1
          
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - script: |
              cd shared
              npm install
            displayName: 'Install shared package dependencies'

          - script: |
              cd apps/frontend
              npm ci
            displayName: 'Install dependencies'
          
          - script: |
              cd apps/frontend
              npm run build
            displayName: 'Build React app'
          
          - script: |
              cd apps/frontend
              npm run lint
            displayName: 'Run linting'
            condition: succeededOrFailed()
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish frontend build'
            inputs:
              pathToPublish: 'apps/frontend/dist'
              artifactName: 'frontend-build'

      # -------------------------------------
      # Frontend Editor (React)
      # -------------------------------------
      - job: BuildFrontendEditor
        displayName: 'Build Frontend Editor (React)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 1
          
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - script: |
              cd shared
              npm install
            displayName: 'Install shared package dependencies'

          - script: |
              cd apps/frontend-editor
              npm ci
            displayName: 'Install dependencies'
          
          - script: |
              cd apps/frontend-editor
              npm run build
            displayName: 'Build React app'
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish editor build'
            inputs:
              pathToPublish: 'apps/frontend-editor/dist'
              artifactName: 'frontend-editor-build'

      # -------------------------------------
      # Load Testing
      # -------------------------------------
      - job: LoadTesting
        displayName: 'Run Load Tests (Medium)'
        pool:
          vmImage: 'ubuntu-latest'
        dependsOn:
          - BuildBackendEditor
          - BuildFrontendEditor
        condition: succeeded()

        services:
          mongodb:
            image: mongo:7
            ports:
              - 27017:27017

        steps:
          - checkout: self
            fetchDepth: 1

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - script: |
              cd shared
              npm install
            displayName: 'Install shared dependencies'

          - script: |
              cd apps/frontend-editor
              npm ci
            displayName: 'Install frontend dependencies'

          - script: |
              cd services/backend-editor
              npm ci
            displayName: 'Install backend dependencies'

          - script: |
              cd scripts/load-test
              ./install-deps.sh
            displayName: 'Install load testing dependencies'

          - script: |
              cd scripts/load-test
              npm run test:medium
            displayName: 'Run load test (medium)'
            timeoutInMinutes: 15

          - task: PublishBuildArtifacts@1
            displayName: 'Publish load test results'
            inputs:
              pathToPublish: 'load-test-metrics-*.json'
              artifactName: 'load-test-results'
            condition: succeededOrFailed()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish load test logs'
            inputs:
              pathToPublish: 'bots.log'
              artifactName: 'load-test-logs'
            condition: succeededOrFailed()

  # ============================================
  # STAGE 2: BUILD DOCKER IMAGES
  # ============================================
  - stage: BuildDockerImages
    displayName: 'Build Docker Images'
    dependsOn: BuildAndTest
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: BuildAndPushImages
        displayName: 'Build and Push All Images'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Login to ACR and Build/Push Images'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Login to Azure Container Registry
                az acr login --name $(acrName)

                # Build and push backend
                docker build -t $(containerRegistry)/backend:$(Build.BuildId) -t $(containerRegistry)/backend:latest -f services/backend/Dockerfile .
                docker push $(containerRegistry)/backend:$(Build.BuildId)
                docker push $(containerRegistry)/backend:latest

                # Build and push backend-editor
                docker build -t $(containerRegistry)/backend-editor:$(Build.BuildId) -t $(containerRegistry)/backend-editor:latest -f services/backend-editor/Dockerfile .
                docker push $(containerRegistry)/backend-editor:$(Build.BuildId)
                docker push $(containerRegistry)/backend-editor:latest

                # Build and push auth-service
                docker build -t $(containerRegistry)/auth-service:$(Build.BuildId) -t $(containerRegistry)/auth-service:latest -f services/auth-service/Dockerfile .
                docker push $(containerRegistry)/auth-service:$(Build.BuildId)
                docker push $(containerRegistry)/auth-service:latest

                # Build and push frontend
                docker build -t $(containerRegistry)/frontend:$(Build.BuildId) -t $(containerRegistry)/frontend:latest -f apps/frontend/Dockerfile .
                docker push $(containerRegistry)/frontend:$(Build.BuildId)
                docker push $(containerRegistry)/frontend:latest

                # Build and push frontend-editor
                docker build -t $(containerRegistry)/frontend-editor:$(Build.BuildId) -t $(containerRegistry)/frontend-editor:latest -f apps/frontend-editor/Dockerfile .
                docker push $(containerRegistry)/frontend-editor:$(Build.BuildId)
                docker push $(containerRegistry)/frontend-editor:latest

  # ============================================
  # STAGE 3: DEPLOY TO CONTAINER APPS
  # ============================================
  - stage: Deploy
    displayName: 'Deploy to Container Apps'
    dependsOn: BuildDockerImages
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployContainerApps
        displayName: 'Update Container Apps'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy to Azure Container Apps'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Update backend
                az containerapp update \
                  --name backend \
                  --resource-group $(resourceGroup) \
                  --image $(containerRegistry)/backend:$(Build.BuildId)

                # Update backend-editor
                az containerapp update \
                  --name backend-editor \
                  --resource-group $(resourceGroup) \
                  --image $(containerRegistry)/backend-editor:$(Build.BuildId)

                # Update auth-service
                az containerapp update \
                  --name auth-service \
                  --resource-group $(resourceGroup) \
                  --image $(containerRegistry)/auth-service:$(Build.BuildId)

                # Update frontend
                az containerapp update \
                  --name frontend \
                  --resource-group $(resourceGroup) \
                  --image $(containerRegistry)/frontend:$(Build.BuildId)

                # Update frontend-editor
                az containerapp update \
                  --name frontend-editor \
                  --resource-group $(resourceGroup) \
                  --image $(containerRegistry)/frontend-editor:$(Build.BuildId)

                echo "All Container Apps updated successfully!"

